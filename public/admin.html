<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Administrador - C.I. Plenitude</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link href="/tailwind.output.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  
  <!-- LOGIN -->
  <div id="loginContainer" class="flex flex-col items-center justify-center min-h-screen bg-gray-50 text-gray-800" style="display:none;">
    <div class="bg-white rounded-xl shadow-xl p-8 w-full max-w-md">
      <h2 class="text-2xl font-bold text-orange-800 mb-4 text-center">Login do Administrador</h2>
      <form id="loginForm" class="space-y-4">
        <input type="email" id="email" class="w-full px-4 py-2 border rounded-lg" placeholder="E-mail" required />
        <input type="password" id="password" class="w-full px-4 py-2 border rounded-lg" placeholder="Senha" required />
        <button type="submit" class="w-full bg-orange-800 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-orange-700 transition duration-150">Entrar</button>
        <p id="loginError" class="text-red-600 text-center mt-2"></p>
      </form>
    </div>
  </div>

  <!-- PAINEL ADMIN -->
  <div id="adminPanel" style="display:none;">
    <header class="bg-orange-800 text-white shadow-md sticky top-0 z-50">
      <div class="max-w-7xl mx-auto flex justify-between items-center px-6 py-4">
        <h1 class="text-2xl font-bold">Administra√ß√£o - C.I. Plenitude</h1>
        <nav class="space-x-6 hidden md:block">
          <a href="#dashboard" class="hover:text-gray-300">Dashboard</a>
          <a href="#mensagens" class="hover:text-gray-300">Mensagens</a>
          <a href="#usuarios" class="hover:text-gray-300">Usu√°rios</a>
          <a href="#configuracoes" class="hover:text-gray-300">Configura√ß√µes</a>
          <a href="/admin.html" class="bg-white text-orange-800 font-semibold px-4 py-2 rounded-lg shadow hover:bg-orange-100 transition duration-150 ml-4">Colaborador</a>
        </nav>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 py-12">
      <!-- SE√á√ïES (mantidas iguais ao seu c√≥digo) -->
      <!-- ... -->
    </main>

    <footer class="bg-orange-800 text-white text-center py-8 mt-12">
      <p>&copy; 2025 Comunidade Internacional Plenitude. Painel do Administrador. <span class="block text-xs mt-2">Vers√£o 1.0.0</span></p>
    </footer>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    // üîπ Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, query, orderBy, limit, doc, setDoc, getDoc,
      addDoc, updateDoc, deleteDoc, Timestamp 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { 
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword,
      createUserWithEmailAndPassword, updateProfile
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { Chart } from "https://cdn.jsdelivr.net/npm/chart.js";

    // üîπ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAxuEEDjn6lPfKOysOcQjvWvUWqJL_990o",
      authDomain: "c-i-plenitude.firebaseapp.com",
      projectId: "c-i-plenitude",
      storageBucket: "c-i-plenitude.appspot.com",
      messagingSenderId: "126733729315",
      appId: "1:126733729315:web:9f247cd8f854fb2e0fbb96",
      measurementId: "G-CGG5MZB9P1"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // üîπ Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
        document.getElementById('loginError').textContent = '';
      } catch {
        document.getElementById('loginError').textContent = 'E-mail ou senha inv√°lidos.';
      }
    });

    // üîπ Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await signOut(auth);
      window.location.reload();
    });

    // üîπ Alterar senha
    document.getElementById('senhaForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const novaSenha = document.getElementById('novaSenha').value;
      try {
        await updatePassword(auth.currentUser, novaSenha);
        document.getElementById('senhaMsg').textContent = 'Senha alterada com sucesso!';
      } catch {
        document.getElementById('senhaMsg').textContent = 'Erro ao alterar senha.';
      }
    });

    // üîπ Exibir/esconder painel conforme login
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        carregarMensagens();
        contarUsuarios();
        carregarBanner();
        carregarEstatisticas();

        // Mostra email do admin
        if (!document.getElementById('adminEmail')) {
          const nav = document.querySelector('nav');
          const span = document.createElement('span');
          span.id = 'adminEmail';
          span.className = 'ml-4 text-sm bg-orange-900 px-2 py-1 rounded';
          span.textContent = 'Logado como: ' + user.email;
          nav.appendChild(span);
        }
      } else {
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('adminPanel').style.display = 'none';
      }
    });

    // üîπ Excluir mensagem (ajustado para deleteDoc)
    function renderMensagens(mensagens) {
      const tbody = document.getElementById('mensagensTable');
      tbody.innerHTML = '';
      mensagens.forEach((msg, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 px-4">${msg.name}</td>
          <td class="py-2 px-4">${msg.email}</td>
          <td class="py-2 px-4">${msg.phone}</td>
          <td class="py-2 px-4">${msg.isWhatsApp}</td>
          <td class="py-2 px-4">${msg.message}</td>
          <td class="py-2 px-4">${msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleString('pt-BR') : '--'}</td>
          <td class="py-2 px-4"><button class="bg-red-600 text-white px-2 py-1 rounded" data-idx="${idx}">Excluir</button></td>
        `;
        tbody.appendChild(tr);
      });

      // Evento de exclus√£o
      Array.from(tbody.querySelectorAll('button')).forEach(btn => {
        btn.addEventListener('click', async () => {
          const i = btn.getAttribute('data-idx');
          const mensagensRef = collection(db, 'mensagens');
          const mensagensSnapshot = await getDocs(query(mensagensRef, orderBy('timestamp', 'desc')));
          let idToDelete = null;
          let idx = 0;
          mensagensSnapshot.forEach(docSnap => {
            if (idx == i) idToDelete = docSnap.id;
            idx++;
          });
          if (idToDelete) {
            await deleteDoc(doc(db, 'mensagens', idToDelete));
            carregarMensagens();
          }
        });
      });
    }

    // üîπ Fun√ß√µes auxiliares (carregar mensagens, contar usu√°rios, banner, estat√≠sticas)
    async function carregarMensagens() {
      const mensagensRef = collection(db, 'mensagens');
      const mensagensSnapshot = await getDocs(query(mensagensRef, orderBy('timestamp', 'desc')));
      const mensagens = [];
      mensagensSnapshot.forEach(doc => mensagens.push(doc.data()));
      document.getElementById('totalMensagens').textContent = mensagens.length;
      if (mensagens.length > 0) {
        document.getElementById('ultimaMensagem').textContent = mensagens[0].message;
      }
      renderMensagens(mensagens);
    }

    async function contarUsuarios() {
      const mensagensRef = collection(db, 'mensagens');
      const mensagensSnapshot = await getDocs(mensagensRef);
      const userIds = new Set();
      mensagensSnapshot.forEach(doc => {
        const data = doc.data();
        if (data.userId) userIds.add(data.userId);
      });
      document.getElementById('usuariosAtivos').textContent = userIds.size;
    }

    async function carregarBanner() {
      const bannerDoc = await getDoc(doc(db, 'config', 'banner'));
      if (bannerDoc.exists()) {
        const url = bannerDoc.data().url;
        document.getElementById('bannerPreview').src = url;
        document.getElementById('bannerPreview').style.display = 'block';
      }
    }

    async function carregarEstatisticas() {
      const mensagensRef = collection(db, 'mensagens');
      const mensagensSnapshot = await getDocs(mensagensRef);
      const porMes = {};
      mensagensSnapshot.forEach(doc => {
        const msg = doc.data();
        if (msg.timestamp) {
          const mes = new Date(msg.timestamp.seconds * 1000).toLocaleString('pt-BR', { month: 'short', year: 'numeric' });
          porMes[mes] = (porMes[mes] || 0) + 1;
        }
      });
      const ctx = document.getElementById('graficoMensagens').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(porMes),
          datasets: [{ label: 'Mensagens por m√™s', data: Object.values(porMes), backgroundColor: 'rgba(255, 115, 0, 0.7)' }]
        }
      });
    }

  </script>
</body>
</html>
